{% extends 'base.html' %}

{% block title %}{{ post.title }} - 블로그{% endblock %}

{% block content %}
<div class="container">
    <article class="post-detail">
        <header class="post-header">
            <h1>{{ post.title }}</h1>
            <div class="post-meta">
                <span>작성자: <a href="{% url 'blog_detail' username=post.author.username %}">{{ post.author.username }}</a></span>
                <span>작성일: {{ post.created_at|date:"Y-m-d H:i" }}</span>
                <span>조회수: {{ post.view_count }}</span>
                {% if post.categories.all %}
                <div class="post-categories">
                    카테고리:
                    {% for category in post.categories.all %}
                        <a href="#" class="category">{{ category.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% if user == post.author %}
            <div class="post-actions">
                <a href="{% url 'post_update' slug=post.slug %}" class="btn-secondary">수정</a>
                <a href="{% url 'post_delete' slug=post.slug %}" class="btn-danger">삭제</a>
            </div>
            {% endif %}
        </header>
        
        <div class="post-content">
            {{ post.content|linebreaks }}
        </div>
        
        <div class="post-footer">
            <h3>댓글 ({{ comments|length }})</h3>
            <div class="comments">
                {% for comment in comments %}
                <div class="comment">
                    <div class="comment-meta">
                        <strong>{{ comment.author.username }}</strong>
                        <span>{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                    </div>
                    <div class="comment-content">
                        {{ comment.content|linebreaks }}
                    </div>
                    <div class="comment-reply">
                        <button class="reply-button">답글</button>
                        <div class="reply-form" style="display: none;">
                            <form method="post" action="{% url 'post_comment' slug=post.slug %}">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <textarea name="content" rows="2" required></textarea>
                                <button type="submit" class="btn-primary">답글 작성</button>
                            </form>
                        </div>
                    </div>
                    
                    {% if comment.replies.all %}
                    <div class="replies">
                        {% for reply in comment.replies.all %}
                        <div class="reply">
                            <div class="comment-meta">
                                <strong>{{ reply.author.username }}</strong>
                                <span>{{ reply.created_at|date:"Y-m-d H:i" }}</span>
                            </div>
                            <div class="comment-content">
                                {{ reply.content|linebreaks }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <p>첫 번째 댓글을 작성해보세요!</p>
                {% endfor %}
            </div>
            
            {% if user.is_authenticated %}
            <div class="comment-form">
                <h4>댓글 작성</h4>
                <form method="post" action="{% url 'post_comment' slug=post.slug %}">
                    {% csrf_token %}
                    {{ comment_form.content }}
                    <button type="submit" class="btn-primary">댓글 작성</button>
                </form>
            </div>
            {% else %}
            <div class="login-prompt">
                <p>댓글을 작성하려면 <a href="{% url 'login' %}">로그인</a>이 필요합니다.</p>
            </div>
            {% endif %}
        </div>
    </article>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const replyButtons = document.querySelectorAll('.reply-button');
        replyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const replyForm = this.nextElementSibling;
                if (replyForm.style.display === 'none') {
                    replyForm.style.display = 'block';
                } else {
                    replyForm.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}